---
date: 2022-01-31T10:14:16+08:00  # 创建日期
author: "Rustle Karl"  # 作者

# 文章
title: "C 语言编译预处理命令"  # 文章标题
# description: "文章描述"
url:  "posts/cpp/quickstart/preprocessing_command"  # 设置网页永久链接
tags: [ "cpp" ]  # 标签
series: [ "C/C++ 学习笔记"]  # 文章主题/文章系列
categories: [ "学习笔记"]  # 文章分类

# 章节
weight: 20 # 排序优先级
chapter: false  # 设置为章节

index: true  # 是否可以被索引
toc: true  # 是否自动生成目录
draft: false  # 草稿
---

预处理命令是在程序编译阶段进行执行的命令，用于编译与特定环境相关的可执行文件。预处理命令扩展了 C 语言。

## 宏替换命令

宏替换命令的作用类似于对源代码文件进行文本替换操作，但是其形式更为灵活丰富。编译器每次遇到宏替换命令所定义的标识符时，都会用其后的字符串替换该标识符。

该命令的一般形式如下：

```c++
#define 标识符 字符串
```

该语句结束时没有分号，所有预处理程序也如此。在标识符和字符串之间可以有任意个空格，字符串一旦开始，仅由一新行结束。如希望 TRUE 取值 1，FALSE 取值 0，可说明两个宏，代码如下


```c++
#define TRUE 1
#define FALSE 0
```

这样在程序中就能直接使用标识符来代表被宏替换的串，C 语言通过这种方法定义符号常量。另一种用法是作为宏代换。宏名可以取参量数，每次遇到宏名时，与之相连的形式参数均由程序中的实际参数代替。例如

```c++
#include <stdio.h>

//定义宏替换MAX（），当a大于或等于b时返回a值，否则返回b
#define MAX(a, b) (a >= b) ? a : b


int main() {
    int x = 190, y = 120;
    printf("MAX: %d", MAX(x, y));

    return 0;
}
```

当编译该程序时，MAX 定义的表达式被替换，程序第 5 行被转换为如下形式。

```c++
printf("MAX: %d", (x >=y) ? x : y));
```

用宏代换代替简单的函数能加快程序执行速度，因为不存在函数调用的开销，同时也提高了代码的可读性。

命令 #undef 用作取消已定义的宏名替换。一般形式如下

```c++
#undef 标识符
```

其主要目的是将宏替换限定在一个代码块内。如下列源代码：

```c++
#define SUCCESS 1 //定义宏 SUCCESS 表示 1
    printf("%d", SUCCESS) //输出宏 SUCCESS 所代表的数值
#undef SUCCESS //取消宏 SUCCESS 的定义
```

## 终止编译命令

在调试程序时，为了提高调试速度，通常在源代码的适当位置加入终止编译命令 #error。它的一般形式是：

```c++
#error 错误信息字符串
```

错误信息字符串不用双引号包围，当程序编译到 #error 指令时，错误信息被显示，如下列源代码所示。

```c++
#error MANUAL_STOP //停止编译，并使编译器提示编译错误信息 MANUAL STOP
```

当编译器编译到这条代码时，就停止工作，并将字符串 MANUAL_STOP 作为错误提示。此命令常与条件编译命令配合使用，使之在特殊的条件下生效。

## 文件包含命令

文件包含命令常用于在编译时插入另一个源程序中的内容。被包含文件的名字必须用一组双引号或一对尖括号包围。

```c++
#include "filename.h“
#include <stdio.h>
```

这两行代码都使编译器读入并编译头文件或源代码文件。双引号用于包含指定相对路径的文件，若未指明相对路径，则会在当前源文件所在的目录内检索。如果文件没找到，则检索标准目录，不检索当前工作目录。尖括号用于包含标准函数库文件和用户在编译指令里所指明的函数库文件，系统会在这些函数库中搜索指定文件。

被包含的文件中也有 #include 命令是允许的，这种方式称为嵌套的嵌入文件，嵌套层次依赖于具体实现。

## 条件编译命令

条件编译命令是编译阶段的逻辑控制结构，通常利用条件编译命令将同一源代码编译为多个不同需求的程序版本。

### #if #else #elif #endif

```c++
#define X 190
#define Y 120

#if X > Y
    printf("MAX: %d", X);
#endif
```

### #ifdef #ifndef

#ifdef 命令用于判断某个宏名是否已定义，如果已定义则执行 #ifndef 与 #endif 间的代码块。#ifndef 命令用于判断某个宏名是否未定义，与前者相反。在头文件中可大量见到这组命令，它们解决了头文件循环嵌套时反复加载同一段定义的风险。#ifdef 和 #ifndef 的命令格式如下：

```c++
#ifdef 标识符
    代码块
#endif

#ifndef 标识符
    代码块
#endif
```

## 修改行号命令

修改行号命令 line 可修改编译器中所标识的源文件行号和文件名信息。编译器在编译时会为源代码的行数编号，以便编译时统计行数和指明警告或错误的行号，同时将源代码文件在文件系统中的文件名作为被编译文件的文件名信息。每行的行号由编译器预定义的宏 LINE 表示，文件名信息由预定义宏 FILE 表示，使用 #line 命令可修改这些信息。#line 命令的格式如下：

```c++
#line 行号 ["文件名字符串"]
```

其中行号可以是整型常量，文件名为任意有效文件标识符。示例代码如下

```c++
// 将文件起始行号改为200，文件名改为 COUNT
#line 200 [COUNT] 
main() {
    printf("%s: %d", _FILE_, _LINE_); // 输出文件名和行号
}
```

使用修改行号可分割一个较大的源代码文件或者在编译时使多个文件可以拥有连贯的信息。

## 编译指示命令

在使用 C 语言开发 Linux 程序时，编译指示命令 #pragma 非常有用。#pragma 命令是预处理命令中最复杂的一个，其作用是设定编译器的状态，或指示编译器完成一些特定的动作。#ragma 指令对每个编译器给出了一个方法，在保持与 ANSI C 标准完全兼容的情况下，给出主机或操作系统专有的特征。依据定义，编译指示是机器或操作系统专有的，且对于每个编译器都是不同的。其格式一般如下：

```c++
#pragma 参数
```

常见的参数如表6.11所示：

![](../assets/images/表6.11_编译指示命令参数列表.png)

## 预定义的宏名

ANSI C 标准有 5 个预定义的宏名，分别是 `_LINE_`、`_FILE_`、`_DATA_`、`_TIME_` 和 `_STDC_`。

- `_LINE_` 宏名代表所处的行在源代码文件中的行号；
- `_FILE_` 宏名代表其所处的源代码文件的名称； 
- `_DATA_` 代表源代码被编译成可执行文件的日期； 
- `_TIME_` 代表源代码被编译成可执行文件的时间； 
- `_STDC_` 用于指示编译器是否执行 ANSI C 标准，如果是，其值为 1。

## 注释

注释的作用是在源代码加便于理解其意义的信息，或者是将暂时不需要使用的代码屏蔽起来。C 语言有两种注释方法，单行注释和多行注释。单行注释用双斜杠`“∥”`表示注释开始，同一行中处于`“∥”`后的文本被当作注释。多行注释用`“/ *”`表示注释的开始，`“* /”`表示注释的结束，其间的文本被当作注释。被注释的代码会被编译器忽略，不会编译到可执行文件中。
